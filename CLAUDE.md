# CLAUDE.md — AI Narrative Engine (RPG2)

## Project Overview

AI Narrative Engine is a free-choice, text-based RPG where stories are dynamically generated by AI. Players type free-text actions (no pre-defined choices), and an AI narrator drives the story forward while a mechanical game engine (dice rolls, stats, HP) enforces world rules. The project is setting-agnostic, supporting any genre or world generated fresh each game.

**Status:** Pre-development / planning phase. Design specifications are complete; no source code has been implemented yet.

## Tech Stack

| Component       | Technology                              |
|-----------------|-----------------------------------------|
| Frontend        | Vanilla HTML / CSS / JavaScript (no framework, no build step) |
| Hosting         | Vercel (free tier, static file deploy)  |
| Database        | Supabase (free tier) — save slots, player data, API keys |
| AI Narration    | Multi-provider: Mistral, Grok, OpenAI (player provides their own API key) |
| Image Gen       | TBD (Phase 2, placeholder only in MVP)  |
| Fonts           | Google Fonts: Cinzel, Crimson Text, Fira Code, IBM Plex Mono |

## Repository Structure

Current state (pre-implementation):

```
RPG2/
├── README.md                                  # Project title
├── AI_Narrative_Engine_MVP_Blueprint.docx      # Full MVP game design document
├── AI_Narrative_Engine_FE_Design_Spec.docx     # Frontend design specification
└── CLAUDE.md                                  # This file
```

### Target file structure (to be built):

```
RPG2/
├── index.html              # Single HTML file with all screen containers (SPA)
├── css/
│   ├── variables.css       # CSS custom properties (colors, fonts, sizes)
│   ├── base.css            # Reset, typography, global styles
│   ├── components.css      # Buttons, inputs, cards, modals, toasts
│   ├── screens.css         # Screen-specific layouts
│   ├── animations.css      # Keyframe animations and transitions
│   ├── console.css         # Debug console styles
│   └── responsive.css      # Media queries and responsive overrides
├── js/
│   ├── app.js              # Entry point, screen router, initialization
│   ├── state.js            # Central game state object
│   ├── api.js              # AI provider API abstraction layer
│   ├── supabase.js         # Supabase client, save/load, player data
│   ├── game-engine.js      # Core game loop, event handling, dice logic, validation
│   ├── ui.js               # DOM manipulation, screen rendering, story display
│   ├── dice.js             # Dice roll animation and calculation
│   ├── console-debug.js    # Debug console: logging, filtering, global error handler
│   ├── utils.js            # Helpers, random flavor text, formatters
│   └── config.js           # Supabase URL and anon key (not secret for MVP)
├── assets/                 # Static assets (icons, dice sprites)
├── AI_Narrative_Engine_MVP_Blueprint.docx
├── AI_Narrative_Engine_FE_Design_Spec.docx
├── README.md
└── CLAUDE.md
```

## Build & Development

### No build step required

This project uses **vanilla HTML/CSS/JS with no framework or bundler**. Files are served as static assets. To develop locally:

```bash
# Any static file server works. Examples:
npx serve .
python3 -m http.server 8000
```

### Deployment

Push to GitHub; Vercel auto-deploys from the repository. No build configuration needed — Vercel serves static files directly.

### No package manager

There is no `package.json`. External dependencies are loaded via CDN:
- **Supabase JS client:** `https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2`
- **Google Fonts:** loaded in `<head>` of `index.html`

## Design System

### Theme: "Dark Arcane Terminal"

Dark backgrounds with warm amber and cool cyan accents. Feels like an enchanted war-room console.

### Color tokens (CSS custom properties)

| Token              | Hex          | Usage                                    |
|--------------------|--------------|------------------------------------------|
| `--bg-primary`     | `#0D0D12`    | Main background                          |
| `--bg-secondary`   | `#151520`    | Cards, panels, modals                    |
| `--bg-tertiary`    | `#1C1C2E`    | Input fields, hover states               |
| `--bg-surface`     | `#22223A`    | Raised surfaces, dropdowns               |
| `--text-primary`   | `#E8E6DF`    | Main body text (warm off-white)          |
| `--text-secondary` | `#9B98A0`    | Labels, descriptions, muted text         |
| `--text-dim`       | `#5A586B`    | Placeholder text, disabled states        |
| `--accent-gold`    | `#D4A053`    | Primary accent: buttons, highlights, XP  |
| `--accent-cyan`    | `#4FC3F7`    | Secondary accent: links, stats, dice     |
| `--accent-red`     | `#E05555`    | Danger: HP loss, crit fail, errors       |
| `--accent-green`   | `#5CB85C`    | Success: pass, HP gain, item found       |
| `--border-subtle`  | `#2A2A40`    | Borders, dividers                        |

### Typography

| Role            | Font            | Weight  | Size      |
|-----------------|-----------------|---------|-----------|
| Display/Title   | Cinzel          | 700     | 28-42px   |
| Headings        | Fira Code       | 600     | 18-24px   |
| Body/Story      | Crimson Text    | 400     | 16-18px   |
| UI/Labels       | IBM Plex Mono   | 400-500 | 12-14px   |

### Responsive breakpoints

| Breakpoint | Width      |
|------------|------------|
| Mobile     | < 640px    |
| Tablet     | 640-1024px |
| Desktop    | > 1024px   |

Use `100dvh` instead of `100vh` for mobile viewport handling.

## Architecture & Key Patterns

### Single-Page Application (SPA)

All screens live in `index.html` as hidden containers. JavaScript handles screen transitions (fade + slide). No page reloads. There are 6 primary screens plus a debug console overlay:

1. **Welcome / Login** — username, API key, provider selection
2. **Main Menu** — New Game, Load Game, Settings
3. **World Creation** — genre, tone, world details form with "Let AI Decide" toggles
4. **Character Creation** — name, gender, stat allocation (10 points across 5 stats), special ability
5. **Gameplay** — main game loop (story display, free-text input, dice rolls, events)
6. **Epilogue** — victory or defeat summary
7. **Debug Console** — overlay panel logging all events and API calls

### Central state object

All game state lives in a single object managed by `js/state.js`. Any module can read/write it. This is the source of truth for character data, world state, NPC profiles, items, HP, XP, etc.

### AI provider abstraction

`js/api.js` exposes a common interface: `sendPrompt(messages, systemPrompt)` that internally routes to the player's selected provider (Mistral, Grok, or OpenAI). API calls are made directly from the browser (acceptable for MVP personal testing; serverless proxy planned for Phase 3).

### Structured AI response format

Every AI response must be valid JSON with this schema:

```json
{
  "story": "string — narrative text",
  "event": null | { "type": "stat_check|combat|item_found|npc_encounter|story_end", "stat": "STR|DEX|INT|CHA|WIL", "difficulty": 1-20, "severity": "basic|important", "success_hint": "string", "fail_hint": "string" },
  "item_gained": null | "string",
  "item_lost": null | "string",
  "new_npc": null | { NPC profile object },
  "npc_updates": null | [{ relationship changes }],
  "hp_change": 0,
  "xp_gained": 0,
  "game_end": false
}
```

### Three-layer validation

1. **Strong prompting** — system prompt defines JSON format with examples (~90% correct)
2. **Validation** — parse JSON, check required fields, validate stat names, difficulty range 1-20, valid event types
3. **Fallback** — if validation fails, treat as story-only (no event). The game never crashes.

### Context window management

Auto-save triggers every X turns (configurable, default 5). Save state includes compressed story summary + last 3-5 raw turns. Old conversation history is flushed and replaced with compressed state to stay within AI context limits.

## Game Mechanics Reference

### Stat system

5 stats, 10 starting points to distribute (max 5 per stat at creation, can increase later):

| Stat         | Abbr | Governs                                          |
|--------------|------|--------------------------------------------------|
| Strength     | STR  | Physical power, melee, endurance                 |
| Dexterity    | DEX  | Agility, stealth, reflexes, ranged               |
| Intelligence | INT  | Knowledge, puzzles, magic, crafting              |
| Charisma     | CHA  | Persuasion, deception, leadership, romance       |
| Willpower    | WIL  | Mental resilience, fear resistance, focus         |

### Dice system

d20 roll + stat bonus >= difficulty = pass. Special ability adds +5 bonus.

| Difficulty       | Target |
|------------------|--------|
| Easy             | 8      |
| Medium           | 12     |
| Hard             | 16     |
| Near Impossible  | 20     |

### Event severity

- **Basic** — story consequence only, no HP loss
- **Important** — HP loss on failure, accumulates toward game over

### NPC system

- **Tier 1 (Key NPCs)** — max 10, saved with full profiles (name, role, personality, appearance, relationship score -100 to +100)
- **Tier 2 (Background)** — narrated by AI, never saved; can be promoted to Tier 1

### Health

Starting HP: 100 (tunable). HP reaches 0 = game over with failure epilogue.

## Supabase Schema

### `players` table

| Column      | Type                         |
|-------------|------------------------------|
| id          | uuid (PK, auto-gen)          |
| username    | text (unique)                |
| ai_provider | text                         |
| api_key     | text                         |
| created_at  | timestamptz (default now())  |

### `save_slots` table

| Column      | Type                         |
|-------------|------------------------------|
| id          | uuid (PK, auto-gen)          |
| player_id   | uuid (FK → players.id)       |
| slot_number | integer                      |
| game_state  | jsonb                        |
| status      | text (default 'active')      |
| updated_at  | timestamptz                  |
| created_at  | timestamptz (default now())  |

Enable Row Level Security (RLS) with a permissive policy for MVP (no auth).

## Implementation Build Order

Follow this order when building features:

1. Project scaffolding — `index.html`, all CSS files, all JS files, folder structure
2. CSS variables and base styles — dark theme foundation
3. **Debug Console** — build FIRST among features; it helps debug everything else
4. Welcome screen — username + API key entry, Supabase connection
5. Main Menu — navigation, save slot picker
6. World Creation — form + AI API integration for world generation
7. Character Creation — stat allocation UI
8. Gameplay: story display + text input + send action
9. Gameplay: event handling + dice roll UI + animation
10. Gameplay: HP/XP tracking + top bar HUD
11. Save/load system integration
12. Epilogue screen
13. Polish — animations, transitions, responsive testing, loading states

## Critical Technical Notes

- All game state must live in a central state object (`js/state.js`)
- The debug console logger must be a global function: `window.debugLog(category, message, data)` callable from any file
- Auto-save is triggered by a **turn counter** in the game engine, not a timer
- Story text typewriter effect must be interruptible (click to show all)
- All screen transitions must clean up event listeners from the previous screen to prevent memory leaks
- JSON validation: use `try/catch` on `JSON.parse`, check required fields, validate stat names against enum, validate difficulty range 1-20
- Install global error handlers (`window.onerror`, `window.onunhandledrejection`) that pipe all uncaught errors to the Debug Console
- All buttons must have minimum 44px touch targets; dice roll button 64px on mobile
- Story area max-width on desktop: ~720px centered for optimal reading line length

## Conventions for AI Assistants

### Code style
- Vanilla JS with ES modules (or simple script loading order)
- No TypeScript, no framework, no build tools
- CSS custom properties for all design tokens — never hardcode colors or sizes
- Semantic HTML where possible
- All CSS organized into separate files by concern (variables, base, components, screens, animations, console, responsive)

### Naming
- CSS classes: kebab-case (e.g., `stat-bar`, `event-card`, `dice-roll-btn`)
- JS variables/functions: camelCase
- JS files: kebab-case
- CSS custom properties: `--category-name` (e.g., `--bg-primary`, `--accent-gold`)

### Error handling
- Every `catch` block must log to the Debug Console via `window.debugLog`
- Never let errors fail silently
- AI response validation failures fall back gracefully to story-only mode

### Security (MVP acceptable trade-offs)
- API keys stored in Supabase and sent from browser (acceptable for personal testing only)
- No authentication for MVP — username-only identification
- Phase 3 will add Vercel serverless functions as API proxy and proper auth

### What NOT to do
- Do not introduce a build step, bundler, or framework
- Do not add npm/node dependencies (use CDN for external libraries)
- Do not skip the Debug Console — it is essential for development
- Do not hardcode colors, font sizes, or spacing — use CSS custom properties
- Do not use `100vh` — use `100dvh` for mobile compatibility
- Do not use timers for auto-save — use the turn counter
